# План исправлений API-запросов

## Проблемы выявленные при анализе

### 1. Дублирование хуков и API-логики
- `useMenu.ts` и `useStrapi.ts` содержат дублирующиеся хуки (`useMenu`, `useSpecialMenu`, `useEvents`, `useUpcomingEvents`)
- `api.ts` и `strapi.ts` содержат дублирующуюся логику для работы с API
- Отсутствие единого подхода к кэшированию и оптимизации запросов

### 2. Отсутствие CORS настроек
- В запросах отсутствуют настройки `mode: 'cors'` и `credentials: 'include'`
- Потенциальные проблемы с cross-origin запросами

### 3. Неоптимальная архитектура
- Смешивание прямых запросов к Strapi и API-маршрутов Next.js
- Отсутствие централизованной обработки ошибок
- Потенциальные дублирующиеся запросы в компонентах

## План исправлений

### Этап 1: Унификация API-слоя (приоритет: критический)

#### 1.1 Обновление strapi.ts с CORS-настройками
- Добавить `mode: 'cors'` и `credentials: 'include'` в fetch запросы
- Улучшить обработку ошибок с детальными сообщениями
- Добавить retry механизм для failed запросов

#### 1.2 Удаление дублирующихся хуков
- Удалить файлы `useMenu.ts` и `useEvents.ts`
- Оставить только `useStrapi.ts` как единый источник хуков
- Обновить импорты во всех компонентах

#### 1.3 Консолидация API-логики
- Оставить `strapi.ts` как основной API-клиент
- Удалить или рефакторить `api.ts` для избежания дублирования
- Унифицировать подходы к работе с данными

### Этап 2: Оптимизация запросов (приоритет: высокий)

#### 2.1 Добавление лимитов и пагинации
- Добавить параметры `pagination[limit]` для всех запросов
- Реализовать lazy loading для больших списков
- Оптимизировать запросы изображений

#### 2.2 Улучшение кэширования
- Расширить функционал `useOptimizedData` для более агрессивного кэширования
- Добавить invalidation стратегии
- Реализовать background refresh для данных

#### 2.3 Создание кастомных хуков
- `useMenuWithCategories` - объединенный запрос меню и категорий
- `useEventsPreview` - оптимизированный запрос для превью событий
- `useFeaturedContent` - агрегированный запрос для главной страницы

### Этап 3: Очистка и оптимизация (приоритет: средний)

#### 3.1 Удаление устаревшего кода
- Очистить файлы в `public/js` (api.js, events.js, menu.js)
- Удалить неиспользуемые зависимости
- Провести аудит импортов

#### 3.2 Обновление компонентов
- Обновить `MenuPreview.tsx` и `Menu.tsx` для использования единого API
- Добавить proper loading states и error boundaries
- Оптимизировать re-renders

### Этап 4: Мониторинг и тестирование (приоритет: средний)

#### 4.1 Добавление логирования
- Логирование API запросов и ошибок
- Мониторинг производительности запросов
- Отслеживание cache hit/miss ratio

#### 4.2 Тестирование
- Unit тесты для API-хуков
- Integration тесты для компонентов
- Performance тесты для оптимизированных запросов

## Ожидаемые результаты

### Производительность
- Сокращение количества API-запросов на 30-40%
- Улучшение времени загрузки страниц
- Более эффективное использование кэша

### Поддерживаемость
- Единый подход к работе с API
- Упрощенная архитектура
- Лучшая обработка ошибок

### UX
- Более быстрые переходы между страницами
- Лучшие loading states
- Меньше "мерцаний" при загрузке данных

## Временные рамки
- Этап 1: 1-2 дня
- Этап 2: 2-3 дня  
- Этап 3: 1 день
- Этап 4: 1-2 дня

**Общее время: 5-8 дней**

## Риски и митигация
- **Риск**: Поломка существующего функционала
- **Митигация**: Поэтапное внедрение с тестированием каждого этапа

- **Риск**: Регрессия производительности
- **Митигация**: Benchmark тесты до и после изменений

- **Риск**: Сложность отладки
- **Митигация**: Подробное логирование и error tracking